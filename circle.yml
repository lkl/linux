general:
  artifacts:

## Customize the test machine
machine:
  # Add some environment variables
  environment:
    CROSS_COMPILE: $([[ $CIRCLE_NODE_INDEX -eq 1 ]] && echo 'i686-w64-mingw32-')

## Customize dependencies
dependencies:
  pre:
    - sudo apt-get update; sudo apt-get install bc libfuse-dev libarchive-dev xfsprogs valgrind gcc-mingw-w64-i686 wine
    - wget -O - http://llvm.org/apt/llvm-snapshot.gpg.key|sudo apt-key add -
    - echo "deb http://llvm.org/apt/precise/ llvm-toolchain-precise main" > /tmp/a && sudo mv /tmp/a /etc/apt/sources.list.d/llvm-precise.list
    - sudo apt-get update
    - sudo apt-get install -qy clang-3.8

test:
  pre:
    - sudo cp tools/lkl/bin/i686-w64-mingw32-* /usr/bin:
        parallel: true

  override:
    - cd tools/lkl && make clean:
        parallel: true
    - cd tools/lkl && make -j8 CC=clang-3.8 HOSTCC=clang-3.8:
        parallel: true
    - cd tools/lkl && make test:
        parallel: true

    - ? >
        if [ -n "${RUN_NIGHTLY_BUILD}" ]; then
          cd tools/lkl && make valgrind;
        fi
      : timeout: 1800 # timeout to 30mins

  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find ./tools/lkl/ -type f -name "*.xml" -exec cp {} $CIRCLE_TEST_REPORTS/ \;
